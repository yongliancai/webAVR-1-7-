<!DOCTYPE html>
<html>
  <head>
    <title>åœ–ç‰‡æ¨™è¨˜ç¶²é </title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="common.css" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
      }

      #imageContainer {
        position: relative;
        margin-bottom: 20px;
      }

      #imageContainer img {
        max-width: 500px;
        max-height: 500px;
      }

      #markerList {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
      }

      .marker {
        width: 50px;
        height: 50px;
        position: absolute;
        background-size: cover;
        display: none; /* åˆå§‹ç‹€æ…‹è¨­ç‚ºä¸é¡¯ç¤º */
      }
      .marker:hover {
        border-color: blue;
      }

      #uploadButton {
        position: relative;
        z-index: 4;
      }
    </style>
  </head>

  <body>
    <header>
      <div class="logo">
        <a href="#">
          <img src="slogo.png" style="width: 50px; height: 50px" />
        </a>
      </div>
      <nav>
        <ul class="navList">
          <li><a href="showCourse.html">ç·¨è¼¯å€</a></li>
          <li><a href="universe.html">å…±äº«å€</a></li>
          <li><a href="personal.html">å€‹äººé </a></li>
          <li><a href="jistsi.html">ç›´æ’­</a></li>
          <li id="userLoginStatus">
            <a href="#" id="loginLink">ç™»å…¥</a>
            <!-- ä¸‹æ‹‰é¸å–®çš„éƒ¨åˆ† -->
            <div id="dropdownMenu" class="dropdown-content">
              <a href="profile.html">å€‹äººè³‡æ–™</a>
              <a href="settings.html">è¨­å®š</a>
              <a href="#" id="logout">ç™»å‡º</a>
            </div>
          </li>
        </ul>
      </nav>
    </header>
    <!--
  <h1>åœ–ç‰‡æ¨™è¨˜ç¶²é </h1>
-->

    <div id="imageContainer">
      <img id="uploadedImage" src="" alt="ä¸Šå‚³çš„åœ–ç‰‡" />
    </div>

    <div id="markerList">
      <button id="uploadButton" onclick="uploadImage()">ä¸Šå‚³åœ–ç‰‡</button>
      <button id="addMarkerButton" onclick="startDrawing()">æ–°å¢æ¨™è¨˜</button>
    </div>
    <div id="tagIcon" style="position: absolute; display: none">ğŸ·ï¸</div>
    <script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-auth.js"></script>
    <script>
      // Initialize Firebase
      var firebaseConfig = {
        apiKey: "AIzaSyC4NzV-q4dBn_IytInpXlbbhEPaHJU9ULk",
        authDomain: "webavr-b9273.firebaseapp.com",
        projectId: "webavr-b9273",
        storageBucket: "webavr-b9273.appspot.com",
        messagingSenderId: "240463881336",
        appId: "1:240463881336:web:6642598bf894378f2ff98d",
        measurementId: "G-6Q7ZQ22WJN",
      };
      firebase.initializeApp(firebaseConfig);

      var storage = firebase.storage();
      var database = firebase.database();

      var uploadedImage = document.getElementById("uploadedImage");
      var markerList = document.getElementById("markerList");

      var markers = [];
      var isDrawing = false;
      var startX, startY;
      var endX, endY;
      var user = firebase.auth().currentUser;
      var imageName;
      var username;
      var email;
      var markerText;
      var downloadimgURL;
      let isMarking = false;
      let isPlaced = false; // ç”¨ä¾†è¨˜éŒ„æ˜¯å¦å·²æ”¾ç½®æ¨™è¨˜
      let currentMarker = null;

      // ç²å– URL ä¸­çš„ query parameters
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      // è®€å–ç‰¹å®šçš„ query parameters
      const category = urlParams.get("category");
      const course = urlParams.get("course");
      var mapLastName = urlParams.get("map");

      // åœ¨æ§åˆ¶å°ä¸Šé¡¯ç¤ºè®€å–åˆ°çš„å€¼
      console.log("Category:", category);
      console.log("Course:", course);
      console.log("mapLastName:", mapLastName);

      function uploadImage() {
        var fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.accept = "image/*";
        fileInput.addEventListener("change", handleFileUpload);
        fileInput.click();
      }

      function handleFileUpload(event) {
        var file = event.target.files[0];
        var storageRef = storage.ref("images/" + file.name);

        storageRef
          .put(file)
          .then(function (snapshot) {
            console.log("ä¸Šå‚³æˆåŠŸ");
            alert("ä¸Šå‚³æˆåŠŸï¼Œè¼‰å…¥åœ–ç‰‡ä¸­");
            return snapshot.ref.getDownloadURL();
          })
          .then(function (downloadURL) {
            uploadedImage.src = downloadURL;
            console.log(downloadURL);
            imageName = file.name.split(".")[0]; // æ›´æ–° imageName è®Šæ•¸
            console.log("imageName:", imageName); // æ·»åŠ èª¿è©¦è¼¸å‡º
            mapLastName = imageName;
            var mapImgURL = {
              URL: downloadURL,
            };
            if (mapLastName == null) {
              mapLastName = imageName;
            }
            var courseRef = database.ref(
              username +
                "/course/" +
                category +
                "/" +
                course +
                "/map/" +
                imageName
            );
            var databaseRef = database.ref(username + "/map/" + imageName);

            // æª¢æŸ¥è³‡æ–™åº«æ˜¯å¦å·²å­˜åœ¨ç›¸æ‡‰çš„ç¯€é»
            courseRef.once("value").then(function (snapshot) {
              if (snapshot.exists()) {
                // å¦‚æœç¯€é»å­˜åœ¨ï¼Œä½¿ç”¨ update æ–¹æ³•æ›´æ–°è³‡æ–™
                courseRef
                  .update(mapImgURL)
                  .then(function () {
                    console.log("æ›´æ–°URLç¯€é»æˆåŠŸ");
                  })
                  .catch(function (error) {
                    console.log("æ›´æ–°URLç¯€é»å¤±æ•—:", error);
                  });
              } else {
                // å¦‚æœç¯€é»ä¸å­˜åœ¨ï¼Œä½¿ç”¨ set æ–¹æ³•å‰µå»ºæ–°çš„è³‡æ–™ç¯€é»
                courseRef
                  .set(mapImgURL)
                  .then(function () {
                    console.log("å‰µå»ºURLç¯€é»æˆåŠŸ");
                  })
                  .catch(function (error) {
                    console.log("å‰µå»ºURLç¯€é»å¤±æ•—:", error);
                  });
              }
            });
            // æª¢æŸ¥è³‡æ–™åº«æ˜¯å¦å·²å­˜åœ¨ç›¸æ‡‰çš„ç¯€é»
            databaseRef
              .once("value")
              .then(function (snapshot) {
                if (snapshot.exists()) {
                  // å¦‚æœç¯€é»å­˜åœ¨ï¼Œä½¿ç”¨ update æ–¹æ³•æ›´æ–°è³‡æ–™
                  databaseRef
                    .update(mapImgURL)
                    .then(function () {
                      console.log("æ›´æ–°URLç¯€é»æˆåŠŸ");
                    })
                    .catch(function (error) {
                      console.log("æ›´æ–°URLç¯€é»å¤±æ•—:", error);
                    });
                } else {
                  // å¦‚æœç¯€é»ä¸å­˜åœ¨ï¼Œä½¿ç”¨ set æ–¹æ³•å‰µå»ºæ–°çš„è³‡æ–™ç¯€é»
                  databaseRef
                    .set(mapImgURL)
                    .then(function () {
                      console.log("å‰µå»ºURLç¯€é»æˆåŠŸ");
                    })
                    .catch(function (error) {
                      console.log("å‰µå»ºURLç¯€é»å¤±æ•—:", error);
                    });
                }
              })
              .catch(function (error) {
                console.log("mapåœ–ç‰‡ä¸Šå‚³å¤±æ•—:", error);
              });
          });
      }

      function startDrawing() {
        isMarking = true;
        currentMarker = document.createElement("div");
        currentMarker.className = "marker";
        currentMarker.style.backgroundImage = "url('mapLogo.png')";
        currentMarker.style.width = "50px";
        currentMarker.style.height = "50px";
        currentMarker.style.backgroundSize = "cover";
        currentMarker.style.position = "absolute";
        currentMarker.style.display = "block";

        document.body.appendChild(currentMarker);
        document.addEventListener("mousemove", handleMouseMove);
        document.addEventListener("click", handleMouseClick);
      }

      function handleMouseMove(event) {
        if (isMarking && currentMarker) {
          currentMarker.style.left = event.pageX - 25 + "px";
          currentMarker.style.top = event.pageY - 25 + "px";
        }
      }

      function handleMarkerClick(event) {
        // é€™è£¡å¯ä»¥é€²è¡Œå…¶ä»–æ“ä½œï¼Œä¾‹å¦‚å½ˆå‡ºä¸€å€‹é¸é …æ¡†æˆ–è·³è½‰é é¢
        const markerName = event.target.getAttribute("data-name");
        console.log(mapLastName, markerName);
        if (!mapLastName || !markerName) {
          console.error("Image name or marker name not found.");
          return;
        }

        const confirmEntry = confirm(`æ˜¯å¦é€²å…¥ ${markerName} æ¨™è¨˜ï¼Ÿ`);
        if (confirmEntry) {
          // å°‡ mapLastName å’Œ markerName ä½œç‚º query parameters é™„åŠ åˆ° URL
          const redirectTo = `show360.html?mapLastName=${encodeURIComponent(
            mapLastName
          )}&markerName=${encodeURIComponent(markerName)}`;

          // é‡æ–°å°å‘åˆ° show360.htmlï¼Œä¸¦æ”œå¸¶ query parameters
          window.location.href = redirectTo;
        }
      }

      function handleMouseClick(event) {
        if (isMarking) {
          if (!isPlaced) {
            isPlaced = true; // è¨­å®šæ¨™è¨˜å·²æ”¾ç½®
          } else {
            isMarking = false;
            isPlaced = false;

            var imageRect = uploadedImage.getBoundingClientRect();
            var markerX = event.pageX - imageRect.left - window.scrollX;
            var markerY = event.pageY - imageRect.top - window.scrollY;

            console.log(`Marker placed at (${markerX}, ${markerY})`);

            let markerName = prompt("Enter marker name:");
            console.log(`Marker name is ${markerName}`);
            saveMarkerToDatabase(markerX, markerY, markerName);

            currentMarker.setAttribute("data-name", markerName);
            currentMarker.addEventListener("click", handleMarkerClick);

            document.removeEventListener("mousemove", handleMouseMove);
            document.removeEventListener("click", handleMouseClick);
          }
        }
      }

      function stopDrawing() {
        isMarking = false;

        document.removeEventListener("mousemove", handleMouseMove);
        document.removeEventListener("click", handleMouseClick);
        document.body.removeChild(currentMarker); // å¾ body ç§»é™¤ currentMarker
        currentMarker = null;
      }

      function saveMarkerToDatabase(x, y, name) {
        currentMarker.markerName = name;
        const markerData = {
          x: x,
          y: y,
          name: name,
        };
        var databaseRef = database.ref(
          sanitizeFirebaseKey(username) +
            "/map/" +
            sanitizeFirebaseKey(imageName) +
            "/markers/" +
            sanitizeFirebaseKey(name)
        );
        databaseRef
          .set(markerData)
          .then(function () {
            console.log("å‰µå»ºç¯€é»æˆåŠŸ");
            alert("æ¨™è¨˜å„²å­˜æˆåŠŸ");
          })
          .catch(function (error) {
            console.log("å‰µå»ºç¯€é»å¤±æ•—:", error);
            alert("å„²å­˜å¤±æ•—ï¼Œæ¨™è¨˜é»åç¨±é ˆä»¥xxå‘½å");
            // ç§»é™¤ç•«é¢ä¸Šçš„æ¨™è¨˜
            if (currentMarker) {
              currentMarker.remove();
            }
          });
      }
      function sanitizeFirebaseKey(key) {
        return key.replace(/[.#$[\]]/g, "_");
      }

      function handleMouseDown(event) {
        isDrawing = true;
        startX = event.clientX - uploadedImage.offsetLeft;
        startY = event.clientY - uploadedImage.offsetTop;
        uploadedImage.addEventListener("mousemove", handleMouseMove);
      }

      // å¾æ•¸æ“šåº«è®€å– markers æ•¸æ“š
      function loadMarkers(mapName, username){
        var markersRef = database.ref(
          username + "/map/" + mapName + "/markers/"
        );
        markersRef.once("value", function (snapshot) {
          snapshot.forEach(function (markerSnapshot) {
            var markerData = markerSnapshot.val();
            console.log(markerData);
            displayMarker(markerData); // åœ¨é é¢ä¸Šé¡¯ç¤ºæ¯å€‹ marker
          });
        });
      }

      function displayMarker(markerData) {
        var marker = document.createElement("div");
        marker.className = "marker";
        marker.style.backgroundImage = "url('mapLogo.png')";
        marker.style.width = "50px";
        marker.style.height = "50px";
        marker.style.backgroundSize = "cover";
        marker.style.position = "absolute";
        marker.style.display = "block";

        var imageRect = uploadedImage.getBoundingClientRect();
        var adjustedX = markerData.x - 25; // åŠ å›åç§»é‡
        var adjustedY = markerData.y - 50; // åŠ å›åç§»é‡

        marker.style.left = imageRect.left + window.scrollX + adjustedX + "px";
        marker.style.top = imageRect.top + window.scrollY + adjustedY + "px";
        marker.setAttribute("data-name", markerData.name); // ç¡®ä¿è¿™é‡Œè®¾ç½®äº† data-name å±æ€§
        marker.addEventListener("click", handleMarkerClick);

        document.body.appendChild(marker);
      }

      function checkIfUserIsStudent(userId, callback) {
        console.log("æ­£åœ¨æª¢æŸ¥ç”¨æˆ¶è§’è‰²ï¼Œç”¨æˆ¶IDï¼š" + userId);
        var studentRef = firebase.database().ref("userRoles/student/" + userId);

        studentRef.once("value", function (snapshot) {
          if (snapshot.exists()) {
            console.log("ç”¨æˆ¶æ˜¯å­¸ç”Ÿ");
            callback(true);
          } else {
            console.log("ç”¨æˆ¶ä¸æ˜¯å­¸ç”Ÿï¼Œæª¢æŸ¥æ˜¯å¦ç‚ºè€å¸«");
            var teacherRef = firebase
              .database()
              .ref("userRoles/teacher/" + userId);
            teacherRef.once("value", function (snapshot) {
              if (snapshot.exists()) {
                console.log("ç”¨æˆ¶æ˜¯è€å¸«");
                callback(false);
              } else {
                console.log("ç”¨æˆ¶æ—¢ä¸æ˜¯å­¸ç”Ÿä¹Ÿä¸æ˜¯è€å¸«");
                callback(false);
              }
            });
          }
        });
      }

      window.addEventListener("DOMContentLoaded", function (event) {
        firebase.auth().onAuthStateChanged(function (user) {
          if (user) {
            email = user.email;
            username = email.split("@")[0];
            console.log("å½“å‰ç”¨æˆ·:", username);
            checkIfUserIsStudent(username, function (isStudent) {
              if (isStudent) {
                var stuTeaRef = firebase
                  .database()
                  .ref(
                    "/userRoles/" + "/student/" + username + "/yourTeacherName/"
                  );
                stuTeaRef.once("value", (snapshot) => {
                  var yourTeacherName = snapshot.val();
                  console.log("yourTeacherNameï¼š" + yourTeacherName);
                  username = yourTeacherName;
                  var urlParams = new URLSearchParams(window.location.search);
                    var mapRef = database.ref(username + "/map/" + mapLastName + "/URL/")
                    mapRef.once("value").then(function (snapshot) {
                      var mapData = snapshot.val();
                      console.log(mapData);
                      // ä½¿ç”¨ mapData é€²è¡Œæ“ä½œï¼Œä¾‹å¦‚é¡¯ç¤ºåœ°åœ–æ•¸æ“š
                      if (mapData) {
                        document.getElementById("uploadedImage").src = mapData;
                        loadMarkers(mapLastName, username); // åŠ è¼‰ markers
                      }
                    });
                  })
                
              } else {
                var urlParams = new URLSearchParams(window.location.search);
                var mapName = urlParams.get("map");
                if (mapName) {
                  // ä½¿ç”¨ mapName å¾ Firebase è®€å–æ•¸æ“š
                  // ä¾‹å¦‚ï¼šè®€å–ç‰¹å®šåœ°åœ–çš„æ•¸æ“šä¸¦é¡¯ç¤º
                  var mapRef = database.ref(
                    username + "/map/" + mapName + "/URL/"
                  );
                  mapRef.once("value").then(function (snapshot) {
                    var mapData = snapshot.val();
                    console.log(mapData);
                    // ä½¿ç”¨ mapData é€²è¡Œæ“ä½œï¼Œä¾‹å¦‚é¡¯ç¤ºåœ°åœ–æ•¸æ“š
                    if (mapData) {
                      document.getElementById("uploadedImage").src = mapData;
                      loadMarkers(mapLastName, username); // åŠ è¼‰ markers
                    }
                  });
                }
              }
            });
          } else {
            // ç”¨æˆ·æœªç™»å½•æˆ–å·²æ³¨é”€
            username = null;
            console.log("å½“å‰ç”¨æˆ·: æœªç™»å½•");
          }
        });
      });
      function checkAuthStatus() {
        firebase.auth().onAuthStateChanged(function (user) {
          if (user) {
            // ç”¨æˆ¶å·²ç™»å…¥
            var username = user.email.split("@")[0]; // ä½¿ç”¨é›»å­éƒµä»¶çš„ @ å‰å­—ä¸²ä½œç‚º username
            document.getElementById(
              "userLoginStatus"
            ).innerHTML = `æ­¡è¿, <a href="#" id="displayName">${username}</a> <div id="dropdownMenu" class="dropdown-content">
          <a href="profile.html">å€‹äººè³‡æ–™</a>
          <a href="settings.html">è¨­å®š</a>
          <a href="#" id="logout">ç™»å‡º</a>
      </div>`;

            // é»æ“Šç”¨æˆ¶åæ™‚é¡¯ç¤ºä¸‹æ‹‰é¸å–®
            document
              .getElementById("displayName")
              .addEventListener("click", function (event) {
                event.preventDefault();
                document.getElementById("dropdownMenu").style.display = "block";
                event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
              });

            // é»æ“Šé é¢å…¶ä»–åœ°æ–¹æ™‚éš±è—ä¸‹æ‹‰é¸å–®
            document.addEventListener("click", function (event) {
              var isClickInsideElement = document
                .getElementById("dropdownMenu")
                .contains(event.target);
              if (!isClickInsideElement) {
                document.getElementById("dropdownMenu").style.display = "none";
              }
            });

            // ç™»å‡ºè™•ç†
            document
              .getElementById("logout")
              .addEventListener("click", function () {
                firebase
                  .auth()
                  .signOut()
                  .then(() => {
                    window.location.href = "index.html"; // é‡å®šå‘åˆ°é¦–é æˆ–å…¶ä»–ä½ å¸Œæœ›çš„é é¢
                    // ç™»å‡ºæˆåŠŸï¼Œé‡å®šå‘æˆ–æ›´æ–°UI
                  })
                  .catch((error) => {
                    // è™•ç†éŒ¯èª¤
                  });
              });
          } else {
            // ç”¨æˆ¶æœªç™»å…¥
            document
              .getElementById("loginLink")
              .setAttribute("href", "index.html");
          }
        });
      }
      // åœ¨é é¢åŠ è¼‰æ™‚èª¿ç”¨
      checkAuthStatus();
    </script>
  </body>
</html>
